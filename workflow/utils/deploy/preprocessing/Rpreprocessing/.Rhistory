data <- list(input_dir = "/input_dir", output_dir = "./results")
yaml::write_yaml(data, configuration_file_path)
# create temporary log_file
log_file <- tempfile("preprocessing", tmpdir = config_folder, ".log")
local_file(log_file)
file.create(log_file)
# run function
result <- loading_config_file(configuration_file_path, log_file)
# check config file structure
expect_true(is.list(result))
expect_true(result$input_dir == "/input_dir")
expect_true(result$output_dir == "./results")
})
devtools::load_all()
devtools::load_all(".")
library(devtools)
devtools::load_all(".")
main()
getwd()
source("./R/checking_configuration")
source("./R/checking_log_file.R")
test_that(
"checking_log_file creates a log file",
{
# create a temporary config folder
tmp_dir <- tempdir()
config_folder <- file.path(tmp_dir)
dir.create(config_folder, showWarnings = FALSE)
# create file path where log_file is expected
log_file <- file.path(config_folder, "preprocessing.log")
# run function
result <- checking_log_file(config_folder)
# log_file is where it is expected
expect_equal(result, log_file)
# file exists
expect_true(file.exists(result))
# file is empty
content <- readLines(result, warn = FALSE)
expect_true(length(content) == 0)
}
)
library(testthat)
source("./R/checking_log_file.R")
test_that(
"checking_log_file creates a log file",
{
# create a temporary config folder
tmp_dir <- tempdir()
config_folder <- file.path(tmp_dir)
dir.create(config_folder, showWarnings = FALSE)
# create file path where log_file is expected
log_file <- file.path(config_folder, "preprocessing.log")
# run function
result <- checking_log_file(config_folder)
# log_file is where it is expected
expect_equal(result, log_file)
# file exists
expect_true(file.exists(result))
# file is empty
content <- readLines(result, warn = FALSE)
expect_true(length(content) == 0)
}
)
check_fastq_files <- function(input_dir, Fastq_file_format, log_file) {
# ------------------------------------------------------------
# Validate Fastq_file_format
# ------------------------------------------------------------
if (!(Fastq_file_format %in% c("merged", "subdir"))) stop("ERROR CODE 5: Invalid Fastq_file_format. Must be      merged or subdir.")
#
# --------------------------------------------------------
#   Case 1: Flat layout - all FASTQs in one directory
# --------------------------------------------------------
#
if (Fastq_file_format == "merged") {
fastq.files <- list.files(input_folder, pattern = "fastq(\\.gz)?$", recursive = FALSE)
if (length(fastq.files) == 0) {
stop(paste0("ERROR CODE 6: No FASTQ files found in ", input_folder))
}
group_names <- sub("^(.*?)(?=R[12])", "\\1", fastq.files, perl = TRUE)
group_names <- sub("[._-]$", "", group_names)
group_names <- unique(group_names)
samples <- list()
for (g in group_names) {
for (file in fastq.files) {
if (grepl("(^|[._-])R1([._-]|$)", file) && (grepl("(^|[._-])R1([._-]|$)", file))) {
samples[[g]][["R1"]] <- file
} else if ((grepl("(^|[._-])R2([._-]|$)", file)) && (grepl("(^|[._-])R2([._-]|$)", file))) {
samples[[g]][["R2"]] <- file
}
}
}
for (sample in names(samples)) {
missing_tags <- c()
if (!("R1" %in% names(samples[[sample]]))) {
missing_tags <- paste0(sample, "_R1")
warning(sample, " R1 file is missing")
}
if (!"R2" %in% names(samples[[sample]])) {
missing_tags <- paste0(sample, "_R2")
warning(sample, " R2 file is missing")
}
if (length(missing_tags) > 0) {
warning(paste0(
sample, " should have 2 FASTQ files. But only ", 2 - (length(missing_tags)), " files found."
))
}
}
return(samples)
}
# ------------------------------------------------------------
# Case 2: Subdirectory layout — one folder per sample
# ------------------------------------------------------------
else if (Fastq_file_format == "subdir") {
subdirs <- list.dirs(input_folder, recursive = FALSE, full.names = TRUE)
if (length(subdirs) == 0) {
stop(paste0("ERROR CODE 7: No sample subdirectories found in ", input_folder))
}
samples <- list()
for (folder in subdirs) {
base_name <- basename(folder)
fastqs <- list.files(folder, pattern = "fastq(\\.gz)?$", recursive = FALSE)
if (length(fastqs) == 0) {
write_log(paste0("WARNING: ", sample_name, " has no FASTQ files"), log_file)
next
} else {
group_name <- sub("^(.*?)(?=R[12])", "\\1", fastq.files, perl = TRUE)
group_name <- sub("[._-]$", "", group_name)
group_name <- unique(group_name)
samples_entry <- list()
for (f in fastqs) {
if (grepl("(^|[._-])R1([._-]|$)", f)) {
if (!("R1" %in% names(samples_entry))) {
samples_entry[["R1"]] <- f
} else {
stop(paste0("ERROR: Multiple R1 files found in folder ", folder))
}
}
if (grepl("(^|[._-])R2([._-]|$)", f)) {
if (!("R2" %in% names(samples_entry))) {
samples_entry[["R2"]] <- f
} else {
stop(paste0("ERROR: Multiple R2 files found in folder ", folder))
}
}
}
samples[[group_name]] <- samples_entry
}
}
for (sample in names(samples)) {
missing_tags <- c()
if (!("R1" %in% names(samples[[sample]]))) {
missing_tags <- paste0(sample, "_R1")
warning(sample, " R1 file is missing")
}
if (!"R2" %in% names(samples[[sample]])) {
missing_tags <- paste0(sample, "_R2")
warning(sample, " R2 file is missing")
}
if (length(missing_tags) > 0) {
warning(paste0(
sample, " should have 2 FASTQ files. But only ", 2 - (length(missing_tags)), " files found."
))
}
}
return(samples)
}
}
check_fastq_files(test_samples, "merged")
check_fastq_files(test_samples, "merged", log_file)
check_fastq_files <- function(input_dir, Fastq_file_format, log_file) {
# ------------------------------------------------------------
# Validate Fastq_file_format
# ------------------------------------------------------------
if (!(Fastq_file_format %in% c("merged", "subdir"))) stop("ERROR CODE 5: Invalid Fastq_file_format. Must be      merged or subdir.")
#
# --------------------------------------------------------
#   Case 1: Flat layout - all FASTQs in one directory
# --------------------------------------------------------
#
if (Fastq_file_format == "merged") {
fastq.files <- list.files(input_dir, pattern = "fastq(\\.gz)?$", recursive = FALSE)
if (length(fastq.files) == 0) {
stop(paste0("ERROR CODE 6: No FASTQ files found in ", input_dir))
}
group_names <- sub("^(.*?)(?=R[12])", "\\1", fastq.files, perl = TRUE)
group_names <- sub("[._-]$", "", group_names)
group_names <- unique(group_names)
samples <- list()
for (g in group_names) {
for (file in fastq.files) {
if (grepl("(^|[._-])R1([._-]|$)", file) && (grepl("(^|[._-])R1([._-]|$)", file))) {
samples[[g]][["R1"]] <- file
} else if ((grepl("(^|[._-])R2([._-]|$)", file)) && (grepl("(^|[._-])R2([._-]|$)", file))) {
samples[[g]][["R2"]] <- file
}
}
}
for (sample in names(samples)) {
missing_tags <- c()
if (!("R1" %in% names(samples[[sample]]))) {
missing_tags <- paste0(sample, "_R1")
warning(sample, " R1 file is missing")
}
if (!"R2" %in% names(samples[[sample]])) {
missing_tags <- paste0(sample, "_R2")
warning(sample, " R2 file is missing")
}
if (length(missing_tags) > 0) {
warning(paste0(
sample, " should have 2 FASTQ files. But only ", 2 - (length(missing_tags)), " files found."
))
}
}
return(samples)
}
# ------------------------------------------------------------
# Case 2: Subdirectory layout — one folder per sample
# ------------------------------------------------------------
else if (Fastq_file_format == "subdir") {
subdirs <- list.dirs(input_dir, recursive = FALSE, full.names = TRUE)
if (length(subdirs) == 0) {
stop(paste0("ERROR CODE 7: No sample subdirectories found in ", input_dir))
}
samples <- list()
for (folder in subdirs) {
base_name <- basename(folder)
fastqs <- list.files(folder, pattern = "fastq(\\.gz)?$", recursive = FALSE)
if (length(fastqs) == 0) {
write_log(paste0("WARNING: ", sample_name, " has no FASTQ files"), log_file)
next
} else {
group_name <- sub("^(.*?)(?=R[12])", "\\1", fastq.files, perl = TRUE)
group_name <- sub("[._-]$", "", group_name)
group_name <- unique(group_name)
samples_entry <- list()
for (f in fastqs) {
if (grepl("(^|[._-])R1([._-]|$)", f)) {
if (!("R1" %in% names(samples_entry))) {
samples_entry[["R1"]] <- f
} else {
stop(paste0("ERROR: Multiple R1 files found in folder ", folder))
}
}
if (grepl("(^|[._-])R2([._-]|$)", f)) {
if (!("R2" %in% names(samples_entry))) {
samples_entry[["R2"]] <- f
} else {
stop(paste0("ERROR: Multiple R2 files found in folder ", folder))
}
}
}
samples[[group_name]] <- samples_entry
}
}
for (sample in names(samples)) {
missing_tags <- c()
if (!("R1" %in% names(samples[[sample]]))) {
missing_tags <- paste0(sample, "_R1")
warning(sample, " R1 file is missing")
}
if (!"R2" %in% names(samples[[sample]])) {
missing_tags <- paste0(sample, "_R2")
warning(sample, " R2 file is missing")
}
if (length(missing_tags) > 0) {
warning(paste0(
sample, " should have 2 FASTQ files. But only ", 2 - (length(missing_tags)), " files found."
))
}
}
return(samples)
}
}
check_fastq_files(test_samples, "merged", log_file)
getwd()
check_fastq_files("test_scripts/test_samples", "merged", log_file)
check_fastq_files <- function(input_dir, Fastq_file_format, log_file) {
# ------------------------------------------------------------
# Validate Fastq_file_format
# ------------------------------------------------------------
if (!(Fastq_file_format %in% c("merged", "subdir"))) stop("ERROR CODE 5: Invalid Fastq_file_format. Must be      merged or subdir.")
#
# --------------------------------------------------------
#   Case 1: Flat layout - all FASTQs in one directory
# --------------------------------------------------------
#
if (Fastq_file_format == "merged") {
fastq.files <- list.files(input_dir, pattern = "fastq(\\.gz)?$", recursive = FALSE)
if (length(fastq.files) == 0) {
stop(paste0("ERROR CODE 6: No FASTQ files found in ", input_dir))
}
group_names <- sub("[._-]?R[12]\\.fastq(\\.gz)?$",, "", fastq.files, perl = TRUE)
group_names <- sub("[._-]$", "", group_names)
group_names <- unique(group_names)
samples <- list()
for (g in group_names) {
for (file in fastq.files) {
if (grepl("(^|[._-])R1([._-]|$)", file) && (grepl("(^|[._-])R1([._-]|$)", file))) {
samples[[g]][["R1"]] <- file
} else if ((grepl("(^|[._-])R2([._-]|$)", file)) && (grepl("(^|[._-])R2([._-]|$)", file))) {
samples[[g]][["R2"]] <- file
}
}
}
for (sample in names(samples)) {
missing_tags <- c()
if (!("R1" %in% names(samples[[sample]]))) {
missing_tags <- paste0(sample, "_R1")
warning(sample, " R1 file is missing")
}
if (!"R2" %in% names(samples[[sample]])) {
missing_tags <- paste0(sample, "_R2")
warning(sample, " R2 file is missing")
}
if (length(missing_tags) > 0) {
warning(paste0(
sample, " should have 2 FASTQ files. But only ", 2 - (length(missing_tags)), " files found."
))
}
}
return(samples)
}
# ------------------------------------------------------------
# Case 2: Subdirectory layout — one folder per sample
# ------------------------------------------------------------
else if (Fastq_file_format == "subdir") {
subdirs <- list.dirs(input_dir, recursive = FALSE, full.names = TRUE)
if (length(subdirs) == 0) {
stop(paste0("ERROR CODE 7: No sample subdirectories found in ", input_dir))
}
samples <- list()
for (folder in subdirs) {
base_name <- basename(folder)
fastqs <- list.files(folder, pattern = "fastq(\\.gz)?$", recursive = FALSE)
if (length(fastqs) == 0) {
write_log(paste0("WARNING: ", sample_name, " has no FASTQ files"), log_file)
next
} else {
group_name <- sub("[._-]?R[12]\\.fastq(\\.gz)?$", "", fastqs, perl = TRUE)
group_name <- sub("[._-]$", "", group_name)
group_name <- unique(group_name)
samples_entry <- list()
for (f in fastqs) {
if (grepl("(^|[._-])R1([._-]|$)", f)) {
if (!("R1" %in% names(samples_entry))) {
samples_entry[["R1"]] <- f
} else {
stop(paste0("ERROR: Multiple R1 files found in folder ", folder))
}
}
if (grepl("(^|[._-])R2([._-]|$)", f)) {
if (!("R2" %in% names(samples_entry))) {
samples_entry[["R2"]] <- f
} else {
stop(paste0("ERROR: Multiple R2 files found in folder ", folder))
}
}
}
samples[[group_name]] <- samples_entry
}
}
for (sample in names(samples)) {
missing_tags <- c()
if (!("R1" %in% names(samples[[sample]]))) {
missing_tags <- paste0(sample, "_R1")
warning(sample, " R1 file is missing")
}
if (!"R2" %in% names(samples[[sample]])) {
missing_tags <- paste0(sample, "_R2")
warning(sample, " R2 file is missing")
}
if (length(missing_tags) > 0) {
warning(paste0(
sample, " should have 2 FASTQ files. But only ", 2 - (length(missing_tags)), " files found."
))
}
}
return(samples)
}
}
check_fastq_files("test_scripts/test_samples", "merged", log_file)
check_fastq_files <- function(input_dir, Fastq_file_format, log_file) {
# ------------------------------------------------------------
# Validate Fastq_file_format
# ------------------------------------------------------------
if (!(Fastq_file_format %in% c("merged", "subdir"))) stop("ERROR CODE 5: Invalid Fastq_file_format. Must be      merged or subdir.")
#
# --------------------------------------------------------
#   Case 1: Flat layout - all FASTQs in one directory
# --------------------------------------------------------
#
if (Fastq_file_format == "merged") {
fastq.files <- list.files(input_dir, pattern = "fastq(\\.gz)?$", recursive = FALSE)
if (length(fastq.files) == 0) {
stop(paste0("ERROR CODE 6: No FASTQ files found in ", input_dir))
}
group_names <- sub("[._-]?R[12]\\.fastq(\\.gz)?$", "", fastq.files, perl = TRUE)
group_names <- sub("[._-]$", "", group_names)
group_names <- unique(group_names)
samples <- list()
for (g in group_names) {
for (file in fastq.files) {
if (grepl("(^|[._-])R1([._-]|$)", file) && (grepl("(^|[._-])R1([._-]|$)", file))) {
samples[[g]][["R1"]] <- file
} else if ((grepl("(^|[._-])R2([._-]|$)", file)) && (grepl("(^|[._-])R2([._-]|$)", file))) {
samples[[g]][["R2"]] <- file
}
}
}
for (sample in names(samples)) {
missing_tags <- c()
if (!("R1" %in% names(samples[[sample]]))) {
missing_tags <- paste0(sample, "_R1")
warning(sample, " R1 file is missing")
}
if (!"R2" %in% names(samples[[sample]])) {
missing_tags <- paste0(sample, "_R2")
warning(sample, " R2 file is missing")
}
if (length(missing_tags) > 0) {
warning(paste0(
sample, " should have 2 FASTQ files. But only ", 2 - (length(missing_tags)), " files found."
))
}
}
return(samples)
}
# ------------------------------------------------------------
# Case 2: Subdirectory layout — one folder per sample
# ------------------------------------------------------------
else if (Fastq_file_format == "subdir") {
subdirs <- list.dirs(input_dir, recursive = FALSE, full.names = TRUE)
if (length(subdirs) == 0) {
stop(paste0("ERROR CODE 7: No sample subdirectories found in ", input_dir))
}
samples <- list()
for (folder in subdirs) {
base_name <- basename(folder)
fastqs <- list.files(folder, pattern = "fastq(\\.gz)?$", recursive = FALSE)
if (length(fastqs) == 0) {
write_log(paste0("WARNING: ", sample_name, " has no FASTQ files"), log_file)
next
} else {
group_name <- sub("[._-]?R[12]\\.fastq(\\.gz)?$", "", fastqs, perl = TRUE)
group_name <- sub("[._-]$", "", group_name)
group_name <- unique(group_name)
samples_entry <- list()
for (f in fastqs) {
if (grepl("(^|[._-])R1([._-]|$)", f)) {
if (!("R1" %in% names(samples_entry))) {
samples_entry[["R1"]] <- f
} else {
stop(paste0("ERROR: Multiple R1 files found in folder ", folder))
}
}
if (grepl("(^|[._-])R2([._-]|$)", f)) {
if (!("R2" %in% names(samples_entry))) {
samples_entry[["R2"]] <- f
} else {
stop(paste0("ERROR: Multiple R2 files found in folder ", folder))
}
}
}
samples[[group_name]] <- samples_entry
}
}
for (sample in names(samples)) {
missing_tags <- c()
if (!("R1" %in% names(samples[[sample]]))) {
missing_tags <- paste0(sample, "_R1")
warning(sample, " R1 file is missing")
}
if (!"R2" %in% names(samples[[sample]])) {
missing_tags <- paste0(sample, "_R2")
warning(sample, " R2 file is missing")
}
if (length(missing_tags) > 0) {
warning(paste0(
sample, " should have 2 FASTQ files. But only ", 2 - (length(missing_tags)), " files found."
))
}
}
return(samples)
}
}
check_fastq_files("test_scripts/test_samples", "merged", log_file)
install.packages("Seurat")
install.packages("Matrix")
devtools::install_github("cran/Matrix")
library("Seurat")
library(Seurat)
install.packages("Matrix")
emotes::install_version("Matrix", version = "1.3.4", repos = "https://cran.r-project.org")
remotes::install_version("Matrix", version = "1.3.4", repos = "https://cran.r-project.org")
remotes::install_version("Matrix", version = "1.7-4", repos = "https://cran.r-project.org")
remotes::install_version("Matrix", version = "1.7.4", repos = "https://cran.r-project.org")
R.version.string
renv::repair()
renv::install("Matrix")
install.packages("Matrix", repos="https://cloud.r-project.org")
install.packages("Seurat")
devtools::load_all(".")
devtools::load_all(".")
devtools::load_all(".")
install.packages("readr")
library("readr")
version("Seurat")
?version
sessionInfo("Seurat")
?write.table()
devtools::load_all()
devtools::load_all()
